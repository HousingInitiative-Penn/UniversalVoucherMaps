---
title: "Voucher_Maps"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load libraries
library(tidyverse)
library(sf)
library(dplyr)
library(tigris)
library(shiny)
library(rgdal)
library(DT)
library(leaflet)
library(leafpop)
library(mapview)
library(RColorBrewer)
library(htmlwidgets)
library(leaflegend)
library(mapview)
library(readxl)

# set working directory
setwd("~/GitHub/UniversalVoucherMaps")

```

# Load Data

```{r states data to load for mapping, message=TRUE, warning=FALSE}
# STATES DATA (update with local file paths, if different)

## Read in the csv
mapdata <- read.csv("data/voucher_map_data_states.csv")

## bring in states shapefile, read as an sf
states <- st_read("data/states_shp/cb_2018_us_state_500k.shp") %>%
  dplyr::select(-AWATER, -ALAND, -STATEFP) %>%
  dplyr::rename(State = NAME) %>%
  st_transform("EPSG:4326")


# # centroids for state labels
# states_centroids <- st_centroid(states)
# 
# states_centroids <- states_centroids %>%
#   dplyr::mutate(x = sf::st_coordinates(.)[,1], 
#                 y = sf::st_coordinates(.)[,2])

# join csv with states
mapdata <- left_join(mapdata, states, by="State")

mapdata <- mapdata %>% st_as_sf() %>%
  st_transform("EPSG:4326")

```

```{r msas data to load for mapping, message=FALSE, warning=FALSE}
# MSAS DATA (update with local file paths, if different)
msas_mapdata <- read.csv("data/voucher_map_data_msas.csv")

# bring in states shapefile, read as an sf
msas <- st_read("data/msas_shp/Metros.shp")%>%
  dplyr::select(-AWATER, -ALAND, -CSAFP, -CBSAFP) %>%
  dplyr::rename(MSA = NAME) %>%
  st_transform(st_crs(states))

# join csv with msas
msas_mapdata <- left_join(msas_mapdata, msas, by="MSA")

msas_mapdata <- msas_mapdata %>% st_as_sf() %>%
  st_transform(st_crs(states))

```

```{r popup content}
#popup content states
state_popup_30AMI = paste(
                "<strong>", "<font size=3.5 color=#009244>",mapdata$State, "</font>", "</strong>","<br>","<hr>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Households Served (30% AMI)", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Number.of.Vouchers.x, "<br>",
                "<strong>", "Annual Cost: ","</strong>",mapdata$Annual.Cost.of.Vouchers.x,"<br>","<br>",
                "<strong>", "<font size=2 color=#1f2859>", "Percent of the State's Vouchers Per Group: ", "</font>", "</strong>","<br>",
                "<strong>", "<font size=1.5>", "Households with Children: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Children.x, "</font>","</em>", "<br>",
                "<strong>", "<font size=1.5>","Households with Seniors: ",  "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Seniors.x,"</font>", "</em>", "<br>",
                "<strong>","<font size=1.5>","Households in Poverty: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.in.Poverty.x, "</font>", "</em>", "<br>",
                "<strong>", "<font size=1.5>","Households with Householders of Color: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Householders.of.Color.x, "</font>","</em>", "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Actual Vouchers Available in 2020", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Actual.Number.of.Vouchers.Available.2020.x, "<br>",
                "<strong>", "Estimated Annual Expenditure: ","</strong>",mapdata$Estimated.Annual.Expenditure.x, "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Eligible Households", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Number.of.Vouchers.if.Only.Renters.Participate.x, "<br>",
                "<strong>", "Annual Cost: ","</strong>",mapdata$Total.Annual.Cost.of.Vouchers.if.Only.Renters.Participate.x,"<br>"
                ) %>%
                lapply(htmltools::HTML)

state_popup_50AMI = paste(
                "<strong>", "<font size=3.5 color=#009244>",mapdata$State, "</font>", "</strong>","<br>","<hr>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Households Served (50% AMI)", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Number.of.Vouchers.y, "<br>",
                "<strong>", "Annual Cost: ","</strong>",mapdata$Annual.Cost.of.Vouchers.y,"<br>","<br>",
                "<strong>", "<font size=2 color=#1f2859>", "Percent of the State's Vouchers Per Group: ", "</font>", "</strong>","<br>",
                "<strong>", "<font size=1.5>", "Households with Children: ",  "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Children.y, "</font>","</em>", "<br>",
                "<strong>", "<font size=1.5>","Households with Seniors: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Seniors.y, "</font>","</em>", "<br>",
                "<strong>","<font size=1.5>","Households in Poverty: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.in.Poverty.y, "</font>","</em>", "<br>",
                "<strong>", "<font size=1.5>","Households with Householders of Color: ", "</strong>",
                "<em>", mapdata$Percent.of.Vouchers.Going.to.Rental.Households.with.Householders.of.Color.y,"</font>", "</em>", "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Actual Vouchers Available in 2020", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Actual.Number.of.Vouchers.Available.2020.y, "<br>",
                "<strong>", "Estimated Annual Expenditure: ","</strong>",mapdata$Estimated.Annual.Expenditure.y, "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Eligible Households", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", mapdata$Number.of.Vouchers.if.Only.Renters.Participate.y, "<br>",
                "<strong>", "Annual Cost: ","</strong>",mapdata$Total.Annual.Cost.of.Vouchers.if.Only.Renters.Participate.y,"<br>"
                ) %>%
                lapply(htmltools::HTML)


#popup content msas
msa_popup_30AMI = paste(
                "<strong>", "<font size=3.5 color=#009244>",msas_mapdata$MSA, "</font>", "</strong>","<br>","<hr>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Households Served (30% AMI)", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Number.of.Vouchers.x, "<br>",
                "<strong>", "Annual Cost: ","</strong>",msas_mapdata$Annual.Cost.of.Vouchers.x,"<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Actual Vouchers Available in 2020", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Actual.Number.of.Vouchers.Available.2020.x, "<br>",
                "<strong>", "Estimated Monthly Expenditure: ","</strong>",msas_mapdata$Estimated.Annual.Expenditure.x, "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Eligible Households", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Number.of.Vouchers.if.Only.Renters.Participate.x, "<br>",
                "<strong>", "Monthly Cost: ","</strong>",msas_mapdata$Total.Annual.Cost.of.Vouchers.if.Only.Renters.Participate.x,"<br>"
                ) %>%
                lapply(htmltools::HTML)
 msa_popup_50AMI = paste(
                "<strong>", "<font size=3.5 color=#009244>",msas_mapdata$MSA, "</font>", "</strong>","<br>","<hr>",
                 "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Households Served (50% AMI)", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Number.of.Vouchers.y, "<br>",
                "<strong>", "Annual Cost: ","</strong>",msas_mapdata$Annual.Cost.of.Vouchers.y,"<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Actual Vouchers Available in 2020", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Actual.Number.of.Vouchers.Available.2020.y, "<br>",
                "<strong>", "Estimated Monthly Expenditure: ","</strong>",msas_mapdata$Estimated.Annual.Expenditure.y, "<br>","<br>",
                "<strong>", "<big>", "<font size=3 color=#1f2859>", "Total Eligible Households", "</font>","</big>", "</strong>","<br>",
                "<strong>", "Number of Vouchers: ","</strong>", msas_mapdata$Number.of.Vouchers.if.Only.Renters.Participate.y, "<br>",
                "<strong>", "Monthly Cost: ","</strong>",msas_mapdata$Total.Annual.Cost.of.Vouchers.if.Only.Renters.Participate.y,"<br>"
              ) %>%
                lapply(htmltools::HTML)
```

```{r data wrangling for samfar sites and soi protections, message=FALSE, warning=FALSE}
# Run data wrangling for safmr and soi protections:

# SAMFAR Sites

## read in counties shapefile
counties <- st_read("data/counties_shp/cb_2018_us_county_500k.shp")
counties$GEOID <- as.character(counties$GEOID)

## read in safmr counties
safmr_counties <- read_excel("data/SAFMR_Counties_Final.xlsx")
safmr_counties$GEOID <- as.character(safmr_counties$GEOID)

safmr_counties_geom <- right_join(counties, safmr_counties, by="GEOID") %>% st_as_sf() %>%
  st_transform("EPSG:4326")

# SOI PROTECTIONS

## read in localities - cities
soi_cities <- read_excel("data/SOI_Localities.xlsx") %>%
  filter(Locality_Type == "City")

soi_cities$GEOID <- as.character(soi_cities$GEOID)

states_with_soi_cities <- c("California", "Colorado", "Delaware", "Georgia", "Illinois", "Iowa", "Kentucky", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Missouri", "New York", "Ohio", "Pennsylvania", "Rhode Island", "Tennessee", "Texas", "Washington", "Wisconsin")

## load places from census using tigris package
options(tigris_class = "sf")
places <- places(state = states_with_soi_cities, cb = TRUE)

soi_cities <- inner_join(soi_cities, places, by="GEOID") %>%
   st_as_sf() %>%
  st_transform(st_crs(states))

# centroids for soi cities labels
soi_cities_centroids <- st_centroid(soi_cities)
 
soi_cities_centroids <- soi_cities_centroids %>%
  dplyr::mutate(x = sf::st_coordinates(.)[,1], 
                 y = sf::st_coordinates(.)[,2])

## localities - counties (GEOIDs)
## santa clara wasn't included in initial file, so added it in (06085)
soi_counties_geoid <- c("06037", "06085", "12011", "12057", "12086", "13075", "24003", "24005", "24021", "24027",
                  "24031", "24033", "36029", "3649506", "36103", "36119", "53033", "55025", "55079")

soi_counties <- st_read("data/counties_shp/cb_2018_us_county_500k.shp") %>%
  filter(GEOID %in% soi_counties_geoid) %>% st_as_sf() %>%
  st_transform("EPSG:4326")

## soi states
soi_states_geoid <- c("06", "09", "08", "10", "11", "23", "24", "25", "27", "34", "36",
              "38", "40", "41", "44", "49", "50", "51", "53")

soi_states <- st_read("data/states_shp/cb_2018_us_state_500k.shp") %>%
  dplyr::select(-AWATER, -ALAND, -STATEFP) %>%
  dplyr::rename(State = NAME) %>%
  filter(GEOID %in% soi_states_geoid)

soi_states_strength <- read_excel("data/SOI_States.xlsx")
soi_states_strength$GEOID <- as.character(soi_states_strength$GEOID)

soi_states <- right_join(soi_states, soi_states_strength, by="GEOID") %>% st_as_sf() %>%
  st_transform(st_crs(states))

# all overlay group names that include custom layer control .pngs - UPDATE FILE PATHS WHEN MOVED TO HIP GITHUB
soi_safmr_overlay_groups <- c("<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_states.png' height='15' width='15'> SOI Protections: States", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_counties.png' height='15' width='15'> SOI Protections: Counties", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_cities.png' height='15' width='15'> SOI Protections: Cities", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_safmr.png' height='15' width='15'> SAFMR Sites")

```

# Voucher Map - States

```{r map states}

# STATES MAP

# Create leaflet palette, labels, map object
bins <- c(0, 25000, 50000, 75000, 100000, 125000, 150000, 175000, 200000, Inf)
palette30 <- colorBin("Greens", mapdata$Number.of.Vouchers.NUMERIC.x, bins = bins)
palette50 <- colorBin("Greens", mapdata$Number.of.Vouchers.NUMERIC.y, bins = bins)

map <- leaflet(map)
    
states_voucher_map <- map %>% setView(lng = -98.34,
                lat = 39.49,
                zoom = 4.25) %>%
  setMaxBounds(lat1=5.499550, lng1=-167.276413, lat2=83.162102, lng2=-52.233040) %>%
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>% # higher zIndex rendered on top
  addProviderTiles("CartoDB.PositronNoLabels",
                                      options = providerTileOptions(minZoom = 3.5)) %>%
  addProviderTiles("CartoDB.PositronOnlyLabels", 
                   options = leafletOptions(pane = "maplabels", providerTileOptions(minZoom = 3.5)),
                   group = "map labels") %>%
  # addLabelOnlyMarkers(data = states_centroids,
  #                   lng = ~x,
  #                   lat = ~y, 
  #                   label = ~STUSPS,
  #                   labelOptions = labelOptions(noHide = TRUE, textOnly = T,
  #                                 style = list(
  #                                 "color" = "black", 
  #                                 "font-weight" = "bold",
  #                                 "font-size" = "12px"
  #                               ))) %>%
  addPolygons(data = mapdata,
              fillColor = ~ palette30(Number.of.Vouchers.NUMERIC.x),
              stroke = T,
              weight=0.5,
              color="grey",
              fillOpacity = 0.8,
              # highlight = highlightOptions(
              #   weight = 1,
              #   color = "black",
              #   fillOpacity = 0.9,
              #   bringToFront = T),
                group = "30%",
              popup = state_popup_30AMI) %>%
  addLegend(data=mapdata,
              position = "bottomright",
            values = ~Number.of.Vouchers.x, 
            pal = palette30,
            opacity = 0.95,
            title = "30%",
            group = "30%",
            className = "info legend 30%") %>%
  addPolygons(data = mapdata,
              fillColor = ~ palette50(Number.of.Vouchers.NUMERIC.y),
              stroke = T,
              weight=0.5,
              color="grey",
              fillOpacity = 0.8,
              # highlight = highlightOptions(
              #   weight = 1,
              #   color = "black",
              #   fillOpacity = 0.9,
              #   bringToFront = T),
              group = "50%",
              popup = state_popup_50AMI)%>%
  addLegend(data=mapdata,
            position = "bottomright",
            values = ~Number.of.Vouchers.y, 
            pal = palette50,
            opacity = 0.95,
            title = "50%",
            group = "50%",
            className = "info legend 50%") %>%
  addPolygons(data = soi_states,
              fill =F,
              opacity = 0.8,
              weight=3,
              color="#1f2859",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_states.png' height='15' width='15'> SOI Protections: States") %>%
  addPolygons(data = soi_counties,
              fill = T,
              fillOpacity = 0.25,
              opacity = 1,
              weight=1.5,
              color="#00CCFF",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_counties.png' height='15' width='15'> SOI Protections: Counties",
              label = paste(
                "<strong>","<font size=2 color=#00CCFF>",soi_counties$NAME,"County","</font>","</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
    addPolygons(data = safmr_counties_geom,
              fill = T,
              fillOpacity = 0.25,
              opacity = 1,
              weight=1.5,
              color="#990066",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_safmr.png' height='15' width='15'> SAFMR Sites",
              label = paste(
                "<strong>","<font size=2 color=#990066>",safmr_counties_geom$County,"</font>", "</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
  addCircleMarkers(data = soi_cities_centroids,
                lng = ~x,
                lat = ~y,
                radius=2.5,
                fillOpacity=.9,
                stroke=T,
                weight = 2,
                fillColor = "#00CCFF",
                color="#1f2859",
               group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_cities.png' height='15' width='15'> SOI Protections: Cities",
              label = paste(
                "<strong>","<font size=2 color=#00CCFF>",soi_cities$Locality_Name,"</font>","</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
   addLayersControl(
     overlayGroups = c("<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_states.png' height='15' width='15'> SOI Protections: States", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_counties.png' height='15' width='15'> SOI Protections: Counties", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_cities.png' height='15' width='15'> SOI Protections: Cities", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_safmr.png' height='15' width='15'> SAFMR Sites"), 
     baseGroups = c("30%", "50%"),
     position = "bottomleft",
     options = layersControlOptions(collapsed = FALSE)) %>%
  htmlwidgets::onRender("
      function(el, x) {
         var updateLegend = function () {
            var selectedGroup = document.querySelectorAll('input:checked')[0].nextSibling.innerText.substr(1);

            document.querySelectorAll('.legend').forEach(a => a.hidden=true);
            document.querySelectorAll('.legend').forEach(l => {
               if (l.classList.contains(selectedGroup)) l.hidden=false;
            });
         };
         updateLegend();
         this.on('baselayerchange', el => updateLegend());
      }") %>%
  htmlwidgets::onRender("
        function() {
            $('.legend').prepend('<label style=\"text-align:left\">Total Households <br>Served at an AMI of: </label><br>');
        }
    ") %>%
  htmlwidgets::onRender("
        function() {
            $('.leaflet-control-layers').prepend('<label style=\"text-align:left\">Select an AMI:</label>');
        }
    ") %>%
htmlwidgets::onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }
  ") %>% hideGroup(soi_safmr_overlay_groups)

states_voucher_map

```

# Voucher Map - MSAs

```{r map msas}
# MSA MAP

# Create leaflet palette, labels, map object
msa_bins <- c(0, 5000, 10000, 15000, 20000, 25000, 30000, 35000, 40000, Inf)
msa_palette30 <- colorBin("Greens", msas_mapdata$Number.of.Vouchers.NUMERIC.x, bins = msa_bins)
msa_palette50 <- colorBin("Greens", msas_mapdata$Number.of.Vouchers.NUMERIC.y, bins = msa_bins)

map <- leaflet(map)
    
msas_voucher_map <- map %>% setView(lng = -98.34,
                lat = 39.49,
                zoom = 4.25) %>%
  setMaxBounds(lat1=5.499550, lng1=-167.276413, lat2=83.162102, lng2=-52.233040) %>%
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>% # higher zIndex rendered on top
  addProviderTiles("CartoDB.PositronNoLabels",
                                      options = providerTileOptions(minZoom = 3.5)) %>%
  addProviderTiles("CartoDB.PositronOnlyLabels", 
                   options = leafletOptions(pane = "maplabels", providerTileOptions(minZoom = 3.5)),
                   group = "map labels") %>%
  addPolygons(data = msas_mapdata,
              fillColor = ~ msa_palette30(Number.of.Vouchers.NUMERIC.x),
              stroke = T,
              weight=1.5,
              color="grey",
              fillOpacity = 0.75,
              # highlight = highlightOptions(
              #   weight = 1,
              #   color = "black",
              #   fillOpacity = 0.9,
              #   bringToFront = T),
              group = "30%",
              popup = msa_popup_30AMI) %>%
  addLegend(data=msas_mapdata,
            position = "bottomright",
            values = ~Number.of.Vouchers.x, 
            pal = msa_palette30,
            opacity = 1,
            title = "30%",
            group = "30%",
            className = "info legend 30%") %>%
  addPolygons(data = msas_mapdata,
              fillColor = ~ msa_palette50(Number.of.Vouchers.NUMERIC.y),
              stroke = T,
              weight=1.5,
              color="grey",
              fillOpacity = 0.75,
              # highlight = highlightOptions(
              #   weight = 1,
              #   color = "black",
              #   fillOpacity = 0.9,
              #   bringToFront = T),
              group = "50%",
              popup = msa_popup_50AMI) %>%
  addLegend(data=msas_mapdata,
            position = "bottomright",
            values = ~Number.of.Vouchers.y, 
            pal = msa_palette50,
            opacity = 1,
            title = "50%",
            group = "50%",
            className = "info legend 50%") %>%
  addPolygons(data = soi_states,
              fill =F,
              opacity = 0.8,
              weight=3,
              color="#1f2859",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_states.png' height='15' width='15'> SOI Protections: States") %>%
  addPolygons(data = soi_counties,
              fill = T,
              fillOpacity = 0.25,
              opacity = 1,
              weight=1.5,
              color="#00CCFF",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_counties.png' height='15' width='15'> SOI Protections: Counties",
              label = paste(
                "<strong>","<font size=2 color=#00CCFF>",soi_counties$NAME,"County","</font>","</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
  addCircleMarkers(data = soi_cities_centroids,
                lng = ~x,
                lat = ~y,
                radius=2.5,
                fillOpacity=.9,
                stroke=T,
                weight = 2,
                fillColor = "#00CCFF",
                color="#1f2859",
               group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_cities.png' height='15' width='15'> SOI Protections: Cities",
              label = paste(
                "<strong>","<font size=2 color=#00CCFF>",soi_cities$Locality_Name,"</font>","</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
  addPolygons(data = safmr_counties_geom,
              fill = T,
              fillOpacity = 0.25,
              opacity = 1,
              weight=1.5,
              color="#990066",
              group = "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_safmr.png' height='15' width='15'> SAFMR Sites",
              label = paste(
                "<strong>","<font size=2 color=#990066>",safmr_counties_geom$County,"</font>", "</strong>") %>%
                lapply(htmltools::HTML),
  ) %>%
   addLayersControl(
     overlayGroups = c("<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_states.png' height='15' width='15'> SOI Protections: States", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_counties.png' height='15' width='15'> SOI Protections: Counties", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_soi_cities.png' height='15' width='15'> SOI Protections: Cities", "<img src='https://housinginitiative-penn.github.io/UniversalVoucherMaps/data/swatch_safmr.png' height='15' width='15'> SAFMR Sites"), 
     baseGroups = c("30%", "50%"),
     position = "bottomleft",
     options = layersControlOptions(collapsed = FALSE)) %>%
  htmlwidgets::onRender("
      function(el, x) {
         var updateLegend = function () {
            var selectedGroup = document.querySelectorAll('input:checked')[0].nextSibling.innerText.substr(1);

            document.querySelectorAll('.legend').forEach(a => a.hidden=true);
            document.querySelectorAll('.legend').forEach(l => {
               if (l.classList.contains(selectedGroup)) l.hidden=false;
            });
         };
         updateLegend();
         this.on('baselayerchange', el => updateLegend());
      }") %>%
  htmlwidgets::onRender("
        function() {
            $('.legend').prepend('<label style=\"text-align:center\">Total Households <br>Served at an AMI of:</label><br>');
        }
    ") %>%
  htmlwidgets::onRender("
        function() {
            $('.leaflet-control-layers').prepend('<label style=\"text-align:left\">Select an AMI:</label>');
        }
    ") %>%
htmlwidgets::onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }
  ") %>% hideGroup(soi_safmr_overlay_groups)

msas_voucher_map

```

```{r save widgets}
# update with today's date, if desired
saveWidget(states_voucher_map, file="states_voucher_map.html")
saveWidget(msas_voucher_map, file="msas_voucher_map.html")
```

